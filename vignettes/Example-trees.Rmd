---
title: "Example trees"
author: "Martin R. Smith"
date: "22 November 2017"
output: rmarkdown::html_document
bibliography: example-trees.bib
vignette: >
  %\VignetteIndexEntry{Example Trees}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r Initialize, include=FALSE}
require('SlowQuartet')
set.seed(1) # 1 produces a random tree with a Qt dist of 226 ~= 330 * 2 / 3

# Colourblind palette from http://mkweb.bcgsc.ca/biovis2012/color-blindness-palette.png
tip_colours <- c(
  rgb(000,000,000, maxColorValue=255),
  rgb(000,073,073, maxColorValue=255),
  rgb(000,146,146, maxColorValue=255),
  rgb(255,109,182, maxColorValue=255),
  rgb(255,182,219, maxColorValue=255),
  rgb(073,000,146, maxColorValue=255),
  rgb(000,109,219, maxColorValue=255),
  rgb(182,109,255, maxColorValue=255),
  rgb(109,182,255, maxColorValue=255),
  rgb(182,219,255, maxColorValue=255),
  rgb(146,000,000, maxColorValue=255),
  rgb(146,073,000, maxColorValue=255),
  rgb(219,109,000, maxColorValue=255),
  rgb(036,255,036, maxColorValue=255),
  rgb(255,255,109, maxColorValue=255)
)[-c(4, 7)] # Rm Tritamopia duplicates of 13 and 3

palette4 <- c(
  rgb(000,000,000, maxColorValue=255),
  rgb(230,159,000, maxColorValue=255),
  rgb(086,180,233, maxColorValue = 255),
  rgb(000,158,115, maxColorValue=255)
)

n_tip <- 11
ref_tree <- ape::read.tree(text="(((1, 2), 3), (((4, 5), 6), ((7, (8, 9)), (10, 11))));")
trs <- test_trees <- list (
  ref_tree      = ref_tree,
  move_one_near = ape::read.tree(text="(((2, 3), 1), (((4, 5), 6), ((7, (8, 9)), (10, 11))));"),
  move_one_mid  = ape::read.tree(text="((2, 3), ((((4, 5), 1), 6), ((7, (8, 9)), (10, 11))));"),
  move_one_far  = ape::read.tree(text="((2, 3), (((4, 5), 6), ((7, (8, 9)), (10, (11, 1)))));"),
  move_two_near = ape::read.tree(text="(((1, 2), 3), (((4, 5), 6), ((7, (10, 11)), (8, 9))));"),
  move_two_mid  = ape::read.tree(text="(((1, 2), 3), ((((4, 5), (10, 11)), 6), (7, (8, 9))));"),
  move_two_far  = ape::read.tree(text="((((1, (10, 11)), 2), 3), (((4, 5), 6), (7, (8, 9))));"),
  collapse_one  = ape::read.tree(text="(((1, 2), 3), (((4, 5), 6), ((7, 8, 9), (10, 11))));"),
  collapse_some = ape::read.tree(text="((1, 2, 3, 4, 5, 6), ((7, 8, 9), (10, 11)));"),
  m1mid_col1    = ape::read.tree(text="((2, 3), ((((1, 4), 5), 6), ((7, 8, 9), (10, 11))));"),
  m1mid_colsome = ape::read.tree(text="((2, 3), ((((1, 4), 5), 6), (7, 8, 9, 10, 11)));"),
  m2mid_col1    = ape::read.tree(text="(((1, 2), 3), ((((4, 5), (10, 11)), 6), (7, 8, 9)));"),
  m2mid_colsome = ape::read.tree(text="(((1, 2), 3), (4, (10, 11), 5, 6, 7, 8, 9));"),
  opposite_tree = ape::read.tree(text="(((1, 11), 3), (((4, 9), 6), ((10, (8, 2)), (5, 7))));"),
  random_tree   = ape::rtree(n_tip, tip.label=seq_len(n_tip), br=NULL)
)

text_x <- -0.1

colplot <- function (tr, title=NULL, bold=NULL) {
  tr$edge.length <- rep(1, dim(tr$edge)[1])
  font <- rep(1, length(tr$tip.label))
  if (!is.null(bold)) font[tr$tip.label %in% bold] <- 4
  plot(tr, tip.col=tip_colours[as.integer(tr$tip.label)], main=title, cex.main=0.8, font=font)
}

rfplot <- function (tr, title, highlight=NULL, ref=ref_tree) {
  tree_dist <- phangorn::treedist(tr, ref)
  tree_pair <- lapply(list(tr, ref), ape::root, outgroup='1', resolve.root=FALSE)
  class(tree_pair) <- 'multiPhylo'
  topo_dist <- as.matrix(ape::dist.topo(tree_pair, method='PH85'))[2]
  
  colplot(tr, title, highlight)
  text(text_x, 10.6, paste0('Quartet = ', choose(11, 4) - MatchingQuartets(list(tr, ref))[1, 2], '/', choose(11,4)), cex=0.8, pos=4)
  text(text_x,  9.6, paste0("RF = ", topo_dist), cex=0.8, pos=4)
  text(text_x,  8.6, paste0("Path = ", signif(tree_dist[2], 3)), cex=0.8, pos=4)
  text(text_x,  7.6, paste0("SPR = ", phangorn::sprdist(tr, ref)[1]), cex=0.8, pos=4)
}


polyplot <- function (tr, title, highlight) {
  tree_pair <- lapply(list(tr, ref_tree), ape::root, outgroup='1', resolve.root=FALSE)
  class(tree_pair) <- 'multiPhylo'
  topo_dist <- as.matrix(ape::dist.topo(tree_pair, method='PH85'))[2]
  
  colplot(tr, title, highlight)
  text(text_x, 10.6, paste0('Quartets contradicted = ', choose(11, 4) - sum(MatchingQuartets(list(tr, ref_tree))[, 2]), '/', choose(11,4)), cex=0.8, pos=4)
  text(text_x,  9.6, paste0('Quartets unresolved = ', MatchingQuartets(list(tr, ref_tree))[2, 2], '/', choose(11,4)), cex=0.8, pos=4)
  text(text_x,  8.6, paste0("RF = ", topo_dist), cex=0.8, pos=4)
}


#par(mfrow=c(3,5), mar=rep(1.2, 4), cex.main=2/3, cex=0.9)
#for (i in seq_along(test_trees)) colplot(test_trees[[i]], names(test_trees)[i])

```

## Tree distance metrics

A number of metrics area available to quantify the similarity between two undirected
topologies (i.e. unrooted trees with no edge lengths).

### Robinson Foulds
The Robinson-Foulds (RF, 'partition' or 'symmetric') [@Robinson1981] metric 
adds the number of bipartitions that are present in tree A (but not tree B)
to the number of bipartitions present in tree B (but not tree A).

### SPR
The subtree pruning and regrafting (SPR) distance [@Penny1985] counts the 
number of SPR rearrangements necessary to transform Tree A into Tree B.

### Path distance
path difference [@Steel1993] 

### Quartet distance
The quartet metric [@Estabrook1985] counts how many of the four-taxon statements 
true in Tree A are also true in Tree B.

For any four tips A, B, C and D, a bipartition on a bifurcating tree will separate
tip A and either B, C or D from the other two tips  That is to say, removing
all other tips from the tree will leave one of the three trees

```{R Three four-taxon trees, echo=FALSE, fig.height=2, fig.width=6}
par(mfrow=c(1, 3), mar=c(0.5, 1, 0.5, 1), cex=1)
tree1 <- ape::read.tree(text='((A, B), (C, D));')
tree2 <- ape::read.tree(text='((A, C), (B, D));')
tree3 <- ape::read.tree(text='((A, D), (C, B));')
plot(tree1, tip.color=palette4[c(1, 2, 3, 4)], font=2)
plot(tree2, tip.color=palette4[c(1, 3, 2, 4)], font=2)
plot(tree3, tip.color=palette4[c(1, 4, 3, 2)], font=2)
```

## Desired behaviour of tree distance metrics

The advantages of the Quartet distance [@Estabrook1985] over other tree distance
metrics [@Penny1985] are best illustrated by examining a set of example trees.

### Moving a single taxon

If trees differ only in the location of a single taxon, then the distance between
two trees should correspond to the distance that this taxon has been moved.

```{R Moving a single taxon, fig.height=3, fig.width=12, echo=FALSE}
par(mfrow=c(1, 4), mar=rep(0.4, 4), cex=1)
colplot(ref_tree,     'Reference tree', 1)
rfplot(trs$move_one_near, 'Short move', 1)
rfplot(trs$move_one_mid, 'Medium move', 1)
rfplot(trs$move_one_far,   'Long move', 1)

```

The subtree pruning and regrafting (SPR) distance [@Penny1985] does not distinguish
between these trees, as they differ only in the placement of a single tip.
The Robinson-Foulds (RF, 'partition' or 'symmetric') [@Robinson1981],
path difference [@Steel1993] and quartet [@Estabrook1985] metrics, 
in contrast, recognize trees in which this tip has been 
moved further as more distant from the starting tree.

### Moving two taxa

Intuitively, moving a pair of tips on a tree should lead to higher tree distances
than moving a single tip.  In the case of a snort move, the RF distance
does not differ whether one or two tips are moved.
For larger moves, however, the RF distance is _less_ when two tips are moved than
when a single tip is moved.  The path and quartet metrics perform as expected.

```{R Moving a cherry, fig.height=8, fig.width=9, echo=FALSE}
par(mfrow=c(3, 3), mar=c(2.4, 0.4, 0.4, 0.4), cex=1)

colplot(ref_tree, 'Reference tree')
rfplot(trs$move_one_near, 'Short move 1', 1)
rfplot(trs$move_two_near, 'Short move 2', 10:11)

colplot(ref_tree, 'Reference tree')
rfplot(trs$move_one_mid, 'Medium move 1', 1)
rfplot(trs$move_two_mid, 'Medium move 2', 10:11)

colplot(ref_tree, 'Reference tree')
rfplot(trs$move_one_far,   'Long move 1', 1)
rfplot(trs$move_two_far,   'Long move 2', 10:11)

```

### Maximum distance
A distance metric should distinguish slightly-peturbed trees from
random trees and those that are more different from the starting tree than 
expected by chance.

The worst-case scenario for the Robinson-Foulds metric involves the relocation
of a single taxon in a pectinate tree. As there are no partitions 
shared between the two trees, this situation generates the maximum
RF distance, and this trivially deformed tree is considered to be as distant
as a random tree.

```{R Increasing distances, fig.height=3, fig.width=9, echo=FALSE}
par(mfrow=c(1, 3), mar=rep(0.4, 4), cex=1)

pectinate_tree  <- ape::read.tree(text='(1, (2, (3, (4, (5, (6, (7, (8, (9, (10, 11))))))))));')
pectinate_unrooted <- ape::unroot(pectinate_tree)
pectinate_move1 <- ape::read.tree(text='(2, (3, (4, (5, (6, (7, (8, (9, (10, (11, 1))))))))));')
colplot(pectinate_tree, 'Pectinate tree')
rfplot(pectinate_move1,  'Move one taxon', 1, ref=pectinate_unrooted)
rfplot(trs$random_tree,   'Random tree',   1, ref=pectinate_unrooted)
```

An advantage of the Quartet distance is that the normalized metric of a random
tree is $2/3$.  As such, trees that are more different than expected by chance
can be readily recognized:

```{R Increasing distances, fig.height=3, fig.width=9, echo=FALSE}
par(mfrow=c(1, 3), mar=rep(0.4, 4), cex=1)
colplot(ref_tree, 'Reference tree')
rfplot(trs$random_tree,   'Random tree'     )
rfplot(trs$opposite_tree, 'Maximum distance')
```

### Unresolved trees

A further benefit is that the Quartet distance can meaningfully score trees
where not every node is resolved as bifurcating.

```{R Polytomies - same topology, fig.height=3, fig.width=9, echo=FALSE}
par(mfrow=c(1, 3), mar=c(2.4, 0.4, 0.4, 0.4), cex=1)

colplot(ref_tree, 'Reference tree')
polyplot(trs$collapse_one, 'One polytomy', 7:9)
polyplot(trs$collapse_some, 'Much polytomy', 1:9)

```

In the above case, the underlying topology was unchanged.  We can also change
the topology -- here we have the same loss of resolution with the trees
in which one taxon (1) was moved:

```{R Polytomies, fig.height=3, fig.width=9, echo=FALSE}
par(mfrow=c(1, 3), mar=c(2.4, 0.4, 0.4, 0.4), cex=1)

polyplot(trs$move_one_mid, 'One moved, no polytomy', 1)
polyplot(trs$m1mid_col1, 'One moved, one polytomy', 1)
polyplot(trs$m1mid_colsome, 'One moved, much polytomy', 1)

```
And here again, collapsing nodes in the trees
in which two taxa (10 & 11) were moved:

```{R Polytomies 2, fig.height=3, fig.width=9, echo=FALSE}
par(mfrow=c(1, 3), mar=c(2.4, 0.4, 0.4, 0.4), cex=1)

polyplot(trs$move_two_mid,  'Two moved, no polytomy'  , 10:11)
polyplot(trs$m2mid_col1,    'Two moved, one polytomy' , 10:11)
polyplot(trs$m2mid_colsome, 'Two moved, much polytomy', 10:11)

```

## References

